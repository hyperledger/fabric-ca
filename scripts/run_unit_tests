#!/bin/bash
#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
FCA=$GOPATH/src/github.com/hyperledger/fabric-ca

echo "Running unit tests ..."
{
export PATH=$PATH:$GOPATH/bin

EXCLUDED_PKGS=(
    "/api$"
    "/credential$"
    "/fabric-ca-client$"
    "/lib/common$"
    "/test/fabric-ca-load-tester$"
    "/mocks$"
    "integration"
    "/ldap"
    "/metrics"
)

<<<<<<< HEAD
# Skipping /lib/common package as there is only one file that contains request/response structs used by both client and server. It needs to be removed from exclude package list
# when code is added to this package
# Skipping credential package as there is only one file that contains Credential interface definition. It needs to be removed from exclude package list when code is added to this package
PKGS=`go list github.com/hyperledger/fabric-ca/... | grep -Ev '/vendor/|/api|/dbutil|integration|/ldap|/mocks|/test/fabric-ca-load-tester|/fabric-ca-client$|/credential$|/lib/common$|/metrics'`
=======
PKGS=`go list github.com/hyperledger/fabric-ca/... | grep -v -f <(printf '%s\n' "${EXCLUDED_PKGS[@]}")`
>>>>>>> eab527aad7b440fd106259f55612f4cfb20cd3cd

gocov test -timeout 15m $PKGS | gocov-xml > coverage.xml
} 2>&1 | tee /tmp/test.results

echo "Finished running all tests"

$FCA/scripts/check_test_results /tmp/test.results

exit $?
